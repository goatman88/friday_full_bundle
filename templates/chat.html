<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title or "Friday AI" }}</title>
  <style>
    :root { --bg:#0b1221; --panel:#0e172a; --ink:#e2e8f0; --muted:#94a3b8; --brand:#60a5fa; --chip:#1f2a44; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header{display:flex;gap:12px;align-items:center;padding:18px 22px;background:var(--panel);border-bottom:1px solid #1f2937;position:sticky;top:0}
    header .dot{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#60a5fa,#34d399)}
    header h1{font-size:16px;margin:0}
    header .meta{margin-left:auto;color:var(--muted);font-size:12px}
    main{max-width:880px;margin:26px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.35);overflow:hidden}
    .thread{padding:18px;display:flex;flex-direction:column;gap:12px;min-height:340px}
    .msg{padding:12px 14px;border-radius:12px;max-width:80%}
    .msg.user{align-self:flex-end;background:#233a78}
    .msg.bot{align-self:flex-start;background:#15223d}
    .typing{color:var(--muted);font-style:italic}
    form{display:flex;gap:10px;padding:14px;background:#0c172e;border-top:1px solid #1f2937}
    textarea{flex:1;resize:none;min-height:44px;max-height:140px;padding:12px 14px;border-radius:12px;border:1px solid #2b3a55;background:#0b1221;color:var(--ink)}
    button{padding:12px 16px;border:0;border-radius:12px;background:var(--brand);color:#0b1221;font-weight:700;cursor:pointer}
    .toolbar{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px;padding:8px 14px;border-top:1px dashed #20304f;background:#0c172e}
    .chip{background:var(--chip);padding:4px 8px;border-radius:999px;border:1px solid #2b3a55}
    .right{margin-left:auto}
    a{color:#8ab4ff;text-decoration:none}
  </style>
</head>

<body>
  <header>
    <div class="dot"></div>
    <h1>Friday AI</h1>
    <div class="meta"><span id="modelChip" class="chip">model…</span></div>
  </header>

  <main>
    <div class="card">
      <div class="thread" id="thread"></div>
      <div class="toolbar">
        <label><input id="streamToggle" type="checkbox" checked> Stream</label>
        <span class="right"><a href="/api/history" target="_blank">history</a> · <a href="/debug/stats" target="_blank">stats</a> · <a href="/routes" target="_blank">routes</a></span>
      </div>
      <form id="form">
        <textarea id="input" placeholder="Type a message…" autofocus></textarea>
        <button id="sendBtn" type="submit">Send</button>
      </form>
    </div>
  </main>

  <script>
    const $ = sel => document.querySelector(sel);
    const thread = $('#thread');
    const input = $('#input');
    const form = $('#form');
    const streamToggle = $('#streamToggle');
    const modelChip = $('#modelChip');

    const el = (cls, text) => {
      const d = document.createElement('div');
      d.className = cls;
      d.textContent = text;
      return d;
    };

    async function hydrate() {
      // model label
      try {
        const m = await fetch('/api/model').then(r=>r.json());
        modelChip.textContent = m.model + (m.has_key ? '' : ' (dev)');
      } catch { modelChip.textContent = 'model?'; }

      // history
      try {
        const hist = await fetch('/api/history').then(r=>r.json());
        hist.forEach(m => {
          thread.appendChild(el(`msg ${m.role==='user'?'user':'bot'}`, m.content));
        });
        thread.scrollTop = thread.scrollHeight;
      } catch {}
      if (thread.children.length === 0) {
        thread.appendChild(el('msg bot', 'Welcome! Ask me anything.'));
      }
    }

    function pushUser(text){
      const m = el('msg user', text);
      thread.appendChild(m);
      thread.scrollTop = thread.scrollHeight;
    }
    function pushBot(text){
      const m = el('msg bot', text);
      thread.appendChild(m);
      thread.scrollTop = thread.scrollHeight;
      return m;
    }

    async function sendMessage(text){
      pushUser(text);
      input.value = '';
      const typing = pushBot('…'); typing.classList.add('typing');

      if (streamToggle.checked){
        const res = await fetch('/api/chat_stream', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({message:text})
        });
        typing.textContent = ''; typing.classList.remove('typing');
        const reader = res.body.getReader();
        const dec = new TextDecoder();
        let acc = '';
        while(true){
          const {done, value} = await reader.read();
          if (done) break;
          const chunk = dec.decode(value, {stream:true});
          chunk.split('\n\n').forEach(line=>{
            if (!line.startsWith('data:')) return;
            const data = JSON.parse(line.slice(5));
            if (data.type === 'delta'){
              typing.textContent += data.text;
            }
          });
        }
        typing.classList.remove('typing');
      } else {
        const j = await fetch('/api/chat', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({message:text})
        }).then(r=>r.json());
        typing.textContent = j.reply || (j.error ? `[${j.error}]` : '…');
        typing.classList.remove('typing');
      }
      thread.scrollTop = thread.scrollHeight;
    }

    form.addEventListener('submit', e=>{
      e.preventDefault();
      const text = input.value.trim();
      if(!text) return;
      sendMessage(text);
    });

    // Enter to send / Shift+Enter newline
    input.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        form.dispatchEvent(new Event('submit'));
      }
    });

    hydrate();
  </script>
</body>
</html>


