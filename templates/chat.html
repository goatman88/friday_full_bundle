<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ title or "Friday AI" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0f172a; --card:#0b233b; --ink:#e5e7eb; --muted:#94a3b8; --accent:#60a5fa; --border:#143251; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 "Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{display:flex;flex-direction:column;height:100%}
    header,footer{background:var(--card);border-color:var(--border)}
    header{border-bottom:1px solid var(--border);padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
    .badge{background:linear-gradient(135deg,#5eead4,#60a5fa);width:30px;height:30px;border-radius:8px;margin-right:8px}
    .links a{color:var(--muted);text-decoration:none;margin-left:12px;font-weight:600}
    .links a:hover{color:var(--accent)}
    .meta{font-size:13px;color:var(--muted);display:flex;justify-content:space-between;align-items:center;padding:8px 16px;background:var(--card);gap:8px;flex-wrap:wrap;border-bottom:1px solid var(--border)}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px}
    .log{flex:1;overflow:auto;padding:22px 18px;display:flex;flex-direction:column;gap:12px}
    .bubble{max-width:72%;padding:12px 14px;border-radius:14px;white-space:pre-wrap;line-height:1.55}
    .u{background:#0b395b;color:#fff;align-self:flex-end}
    .a{background:#12273f;align-self:flex-start}
    footer{border-top:1px solid var(--border);padding:12px 16px;display:flex;gap:8px}
    input[type=text]{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0e2138;color:var(--ink)}
    button{background:var(--accent);color:#fff;border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer;letter-spacing:.2px}
    button.secondary{background:transparent;color:var(--muted);border:1px solid var(--border)}
    button.warn{background:#ef4444}
    select{background:#0e2138;color:var(--ink);border:1px solid var(--border);border-radius:10px;padding:8px}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap" id="root">
  <header>
    <div style="display:flex;align-items:center"><div class="badge"></div><strong>Friday AI</strong></div>
    <div class="links">
      <a href="/chat">/chat</a> · <a href="/admin" target="_blank">admin</a> ·
      <a id="routesLink" href="#">routes</a> · <a id="healthLink" href="#">health</a> · <a id="statsLink" href="#">stats</a>
    </div>
  </header>

  <div class="meta">
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <label><input id="stream" type="checkbox" checked> Stream</label>
      · Model: <select id="model"></select>
      · <label><input id="useRag" type="checkbox"> Use RAG (top snippets)</label>
      <span id="commit" class="pill"></span>
      <span id="cidLabel" class="pill"></span>
    </div>
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
      <button id="loginBtn" class="secondary">Login</button>
      <button id="logoutBtn" class="secondary" style="display:none">Logout</button>
      <button id="newCid" class="secondary">New session</button>
      <button id="clearChat" class="secondary">Clear session</button>
      <button id="downloadChat" class="secondary">Download</button>
      <button id="purgeAll" class="warn">Clear ALL</button>
    </div>
  </div>

  <div id="log" class="log"></div>

  <footer>
    <input id="msg" type="text" placeholder="Type a message… (Enter to send)"/>
    <button id="send">Send</button>
  </footer>
</div>

<script>
const base = location.origin;
const log = document.querySelector("#log");
const msg = document.querySelector("#msg");
const sendBtn = document.querySelector("#send");
const modelSel = document.querySelector("#model");
const commitSpan = document.querySelector("#commit");
const cidLabel = document.querySelector("#cidLabel");
const newCidBtn = document.querySelector("#newCid");
const clearBtn = document.querySelector("#clearChat");
const downloadBtn = document.querySelector("#downloadChat");
const purgeAllBtn = document.querySelector("#purgeAll");
const streamChk = document.querySelector("#stream");
const routesLink = document.querySelector("#routesLink");
const healthLink = document.querySelector("#healthLink");
const statsLink = document.querySelector("#statsLink");
const loginBtn = document.querySelector("#loginBtn");
const logoutBtn = document.querySelector("#logoutBtn");
const useRagChk = document.querySelector("#useRag");

function token(){ return localStorage.getItem("JWT") || ""; }
function headers(json=true){
  const h = json ? {"Content-Type":"application/json"} : {};
  const t = token(); if(t) h["Authorization"] = "Bearer " + t;
  return h;
}
function authed(){ return !!token(); }
function showAuthButtons(){ loginBtn.style.display = authed()?"none":""; logoutBtn.style.display = authed()?"": "none"; }

function getCid(){
  let c = localStorage.getItem("cid");
  if(!c){ c = crypto.randomUUID(); localStorage.setItem("cid", c); }
  cidLabel.textContent = `cid: ${c.slice(0,8)}…`;
  return c;
}
function setCid(c){
  localStorage.setItem("cid", c);
  cidLabel.textContent = `cid: ${c.slice(0,8)}…`;
}
function append(role, text){
  const b = document.createElement("div");
  b.className = `bubble ${role==="user"?"u":"a"}`;
  b.textContent = text;
  log.appendChild(b); log.scrollTop = log.scrollHeight;
}
function clearUI(){ log.innerHTML = ""; }

async function loadModels(){
  try{
    const j = await fetch(`${base}/api/models`).then(r=>r.json());
    modelSel.innerHTML = "";
    (j.available||[]).forEach(m=>{
      const o = document.createElement("option"); o.value=m; o.textContent=m;
      if(m === j.active) o.selected = true; modelSel.appendChild(o);
    });
  }catch{ modelSel.innerHTML = "<option>(error)</option>"; }
}
modelSel.onchange = async ()=>{
  try{
    const j = await fetch(`${base}/api/model`,{method:"POST", headers:headers(), body:JSON.stringify({model:modelSel.value})}).then(r=>r.json());
    append("assistant", `Model switched to: ${j.active}`);
  }catch(e){ append("assistant", "Model switch error: " + e.message); }
};

async function sendMsg(cid, text){
  // optional: RAG prepend
  if(authed() && useRagChk.checked){
    try{
      const rag = await fetch(`${base}/api/rag/search?q=${encodeURIComponent(text)}&k=3`, {headers:headers(false)}).then(r=>r.json());
      if(rag.results?.length){
        const ctx = rag.results.map(r=>`[${r.score}] ${r.snippet}`).join("\n---\n");
        text = `Use this context to answer:\n${ctx}\n\nUser: ${text}`;
      }
    }catch{}
  }
  const j = await fetch(`${base}/api/chat?cid=${encodeURIComponent(cid)}`, {
    method:"POST", headers:headers(), body:JSON.stringify({message:text})
  }).then(r=>r.json());
  if(j.cid && j.cid !== cid) setCid(j.cid);
  return j;
}

async function sendStream(cid, text, onDelta, onDone){
  // optional: RAG
  if(authed() && useRagChk.checked){
    try{
      const rag = await fetch(`${base}/api/rag/search?q=${encodeURIComponent(text)}&k=3`, {headers:headers(false)}).then(r=>r.json());
      if(rag.results?.length){
        const ctx = rag.results.map(r=>`[${r.score}] ${r.snippet}`).join("\n---\n");
        text = `Use this context to answer:\n${ctx}\n\nUser: ${text}`;
      }
    }catch{}
  }
  const url = new URL(`${base}/api/chat/stream`);
  url.searchParams.set("cid", cid);
  url.searchParams.set("q", text);
  const resp = await fetch(url, { headers: headers(false) });
  const reader = resp.body.getReader(); const dec = new TextDecoder();
  let acc = "";
  for(;;){
    const {value, done} = await reader.read();
    if(done) break;
    const chunk = dec.decode(value);
    chunk.split("\n\n").forEach(line=>{
      if(line.startsWith("data: ")){
        try{
          const obj = JSON.parse(line.slice(6));
          if(obj.delta){ acc += obj.delta; onDelta && onDelta(obj.delta, acc); }
          if(obj.done){ onDone && onDone(acc); }
        }catch{}
      }
    });
  }
}

async function send(){
  const text = msg.value.trim(); if(!text) return;
  append("user", text); msg.value = "";
  const cid = getCid();

  if(streamChk.checked){
    const bubble = document.createElement("div"); bubble.className="bubble a"; bubble.textContent="…"; log.appendChild(bubble);
    await sendStream(cid, text, (_d, acc)=>{ bubble.textContent = acc; log.scrollTop = log.scrollHeight; }, (_final)=>{});
  } else {
    try{
      const j = await sendMsg(cid, text);
      append("assistant", j.reply ?? JSON.stringify(j));
    }catch(e){ append("assistant", "Request failed: " + e.message); }
  }
}

// nav & actions
routesLink.onclick = async e => { e.preventDefault(); append("assistant", JSON.stringify(await (await fetch(base+"/routes")).json(), null, 2)); };
healthLink.onclick = async e => { e.preventDefault(); const j = await (await fetch(base+"/debug/health")).json(); commitSpan.textContent = j.commit ? "commit "+j.commit : ""; append("assistant", JSON.stringify(j,null,2)); };
statsLink.onclick  = async e => { e.preventDefault(); append("assistant", JSON.stringify(await (await fetch(base+"/api/stats")).json(), null, 2)); };

newCidBtn.onclick = ()=>{ setCid(crypto.randomUUID()); clearUI(); append("assistant","Started fresh session."); };
clearBtn.onclick = async ()=>{ const cid = getCid(); await fetch(`${base}/api/history?cid=${encodeURIComponent(cid)}`, {method:"DELETE",headers:headers(false)}); clearUI(); append("assistant","Cleared chat history for this session."); };
downloadBtn.onclick = async ()=>{ const cid = getCid(); const res = await fetch(`${base}/api/history/export_file?cid=${encodeURIComponent(cid)}`,{headers:headers(false)}); const blob = await res.blob(); const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`friday_${cid.slice(0,8)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); };
purgeAllBtn.onclick = async ()=>{ const tok = prompt("Admin token to purge ALL:"); if(!tok) return; const r = await fetch(`${base}/api/admin/purge_all`, {method:"DELETE", headers:{ "X-Admin-Token": tok }}); const j = await r.json(); append("assistant", r.ok? `Purged ${j.purged_count} sessions` : "Admin purge failed: "+(j.error||r.status)); };

sendBtn.onclick = send;
msg.addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); } });

async function doLogin(){
  const email = prompt("Email:"); if(!email) return;
  const pwd = prompt("Password:");
  const res = await fetch(`${base}/auth/login`, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({email, password: pwd})});
  const j = await res.json();
  if(res.ok && j.token){ localStorage.setItem("JWT", j.token); showAuthButtons(); append("assistant", `Logged in as ${j.name||email}`); }
  else { if(confirm("No account? Create one now?")) { const n = prompt("Name (optional):")||""; const rr = await fetch(`${base}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email, password: pwd, name:n})}); const jj = await rr.json(); if(rr.ok && jj.token){ localStorage.setItem("JWT", jj.token); showAuthButtons(); append("assistant","Account created & logged in."); } else { append("assistant","Auth failed: "+(jj.error||rr.status)); } } }
}
loginBtn.onclick = doLogin;
logoutBtn.onclick = ()=>{ localStorage.removeItem("JWT"); showAuthButtons(); append("assistant","Logged out."); };

(async function boot(){
  showAuthButtons();
  getCid(); loadModels();
  fetch(`${base}/debug/health`).then(r=>r.json()).then(j=>{ if(j.commit) commitSpan.textContent = "commit "+j.commit; });
})();
</script>
</body>
</html>












