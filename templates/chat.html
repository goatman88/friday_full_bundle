<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ title or "Friday AI" }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --bg:#0f172a; --card:#0b233b; --ink:#e5e7eb; --muted:#94a3b8; --accent:#60a5fa; }
    [data-theme="light"] { --bg:#f1f5f9; --card:#fff; --ink:#111; --muted:#444; --accent:#2563eb; }
    html,body{height:100%; margin:0; font:15px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink);}
    .wrap{display:flex; flex-direction:column; height:100%}
    header{background:var(--card); border-bottom:1px solid #143251; padding:10px 16px; display:flex; justify-content:space-between; align-items:center}
    .ttl{display:flex; align-items:center; gap:8px; font-weight:700}
    .badge{background:linear-gradient(135deg,#5eead4,#60a5fa); width:28px; height:28px; border-radius:8px}
    .links a{color:var(--muted); text-decoration:none; margin-left:12px}
    .links a:hover{color:var(--accent)}
    .log{flex:1; overflow:auto; padding:20px; display:flex; flex-direction:column; gap:10px}
    .bubble{max-width:72%; padding:10px 14px; border-radius:12px; white-space:pre-wrap}
    .u{background:#0b395b; align-self:flex-end; color:#fff}
    .a{background:#12273f; align-self:flex-start}
    [data-theme="light"] .u{background:#dbeafe; color:#111}
    [data-theme="light"] .a{background:#e2e8f0; color:#111}
    .meta{font-size:13px; color:var(--muted); display:flex; justify-content:space-between; align-items:center; padding:6px 16px; background:var(--card); gap:8px; flex-wrap:wrap}
    select{background:#0e2138; color:var(--ink); border:1px solid #183a5b; border-radius:8px; padding:6px}
    [data-theme="light"] select{background:#fff; border:1px solid #ccc}
    .pill{padding:4px 8px; border:1px solid #183a5b; border-radius:8px; font-size:12px}
    footer{background:var(--card); border-top:1px solid #143251; padding:12px 16px; display:flex; gap:8px; position:sticky; bottom:0}
    input[type=text]{flex:1; padding:12px; border-radius:12px; border:1px solid #183a5b; background:#0e2138; color:var(--ink)}
    [data-theme="light"] input[type=text]{background:#fff; border:1px solid #ccc}
    button{background:var(--accent); color:#fff; border:0; padding:12px 16px; border-radius:12px; font-weight:600; cursor:pointer}
    button.secondary{background:transparent; color:var(--muted); border:1px solid #183a5b}
    button.warn{background:#ef4444}
    button:hover{opacity:.9}
    .themeToggle{cursor:pointer; margin-left:10px; font-size:13px; color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap" id="appRoot">

  <header>
    <div class="ttl"><div class="badge"></div> Friday AI</div>
    <div class="links">
      <a href="/chat">/chat</a>
      Â· <a id="routesLink" href="#">routes</a>
      Â· <a id="healthLink" href="#">health</a>
      Â· <a id="statsLink" href="#">stats</a>
      Â· <a id="historyLink" href="#">history</a>
      Â· <a id="exportLink" href="#">export</a>
      Â· <a href="/admin" target="_blank" title="Admin Panel">admin</a>
      <span class="themeToggle" onclick="toggleTheme()">ðŸŒ“ Theme</span>
    </div>
  </header>

  <div id="log" class="log"></div>

  <div class="meta">
    <div>
      <label><input id="stream" type="checkbox" checked> Stream</label>
      Â· Model: <select id="model"></select>
      <span id="commit"></span>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <span id="cidLabel" class="pill"></span>
      <button id="newCid" class="secondary">New session</button>
      <button id="clearChat" class="secondary" title="Clear UI and server history for this session">Clear chat</button>
      <button id="downloadChat" class="secondary" title="Download this session as JSON">Download</button>
      <button id="purgeAll" class="warn" title="Admin: purge ALL sessions">Clear ALL</button>
    </div>
  </div>

  <footer>
    <input id="msg" type="text" placeholder="Type a messageâ€¦" />
    <button id="send">Send</button>
  </footer>
</div>

<script>
  const base = location.origin;
  const appRoot = document.querySelector("#appRoot");
  const log = document.querySelector("#log");
  const msg = document.querySelector("#msg");
  const sendBtn = document.querySelector("#send");
  const modelSel = document.querySelector("#model");
  const commitSpan = document.querySelector("#commit");
  const cidLabel = document.querySelector("#cidLabel");
  const newCidBtn = document.querySelector("#newCid");
  const clearBtn = document.querySelector("#clearChat");
  const downloadBtn = document.querySelector("#downloadChat");
  const purgeAllBtn = document.querySelector("#purgeAll");
  const streamChk = document.querySelector("#stream");

  // --- Theme persistence ---
  function loadTheme() {
    const t = localStorage.getItem("theme") || "dark";
    appRoot.setAttribute("data-theme", t);
  }
  function toggleTheme() {
    const current = appRoot.getAttribute("data-theme");
    const next = current === "light" ? "dark" : "light";
    appRoot.setAttribute("data-theme", next);
    localStorage.setItem("theme", next);
  }

  // --- Session
  function getCid(){
    let c = localStorage.getItem("cid");
    if(!c){ c = crypto.randomUUID(); localStorage.setItem("cid", c); }
    cidLabel.textContent = `cid: ${c.slice(0,8)}â€¦`;
    return c;
  }
  function setCid(c){
    localStorage.setItem("cid", c);
    cidLabel.textContent = `cid: ${c.slice(0,8)}â€¦`;
  }

  // --- UI helpers
  function append(role, text){
    const b = document.createElement("div");
    b.className = `bubble ${role==="user"?"u":"a"}`;
    b.textContent = text;
    log.appendChild(b);
    log.scrollTop = log.scrollHeight;
  }
  function clearUI(){ log.innerHTML = ""; }

  // --- Models
  async function loadModels(){
    try{
      const r = await fetch(`${base}/api/models`);
      const j = await r.json();
      modelSel.innerHTML = "";
      (j.available || []).forEach(m=>{
        const o = document.createElement("option");
        o.value = m; o.textContent = m;
        if(m === j.active) o.selected = true;
        modelSel.appendChild(o);
      });
    }catch{ modelSel.innerHTML = "<option>(error)</option>"; }
  }
  modelSel.onchange = async ()=>{
    try{
      const r = await fetch(`${base}/api/model`,{
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ model: modelSel.value })
      });
      const j = await r.json();
      append("assistant", `Model switched to: ${j.active}`);
    }catch(e){ append("assistant", "Model switch error: " + e.message); }
  };

  // --- Send
  async function send(){
    const text = msg.value.trim(); if(!text) return;
    append("user", text); msg.value = "";
    const cid = getCid();

    if(streamChk.checked){
      const url = new URL(`${base}/api/chat/stream`);
      url.searchParams.set("cid", cid);
      url.searchParams.set("q", text);
      const resp = await fetch(url);
      const reader = resp.body.getReader();
      let acc = "", streamingDiv = null;
      while(true){
        const {value, done} = await reader.read(); if(done) break;
        const chunk = new TextDecoder().decode(value);
        chunk.split("\n\n").forEach(line=>{
          if(line.startsWith("data: ")){
            try{
              const obj = JSON.parse(line.slice(6));
              if(obj.delta){
                acc += obj.delta;
                if(!streamingDiv){ streamingDiv = document.createElement("div"); streamingDiv.className = "bubble a"; log.appendChild(streamingDiv); }
                streamingDiv.textContent = acc; log.scrollTop = log.scrollHeight;
              }
              if(obj.done){ streamingDiv = null; loadModels(); }
            }catch{}
          }
        });
      }
    } else {
      const r = await fetch(`${base}/api/chat?cid=${cid}`,{
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ message: text })
      });
      const j = await r.json();
      if(j.cid && j.cid !== cid) setCid(j.cid);
      append("assistant", j.reply ?? JSON.stringify(j));
      loadModels();
    }
  }

  // --- Links
  document.querySelector("#routesLink").onclick = async e => { e.preventDefault(); append("assistant", JSON.stringify(await (await fetch(base+"/routes")).json(), null, 2)); };
  document.querySelector("#healthLink").onclick = async e => { e.preventDefault(); const j = await (await fetch(base+"/debug/health")).json(); commitSpan.textContent = j.commit ? "commit " + j.commit : ""; append("assistant", JSON.stringify(j, null, 2)); };
  document.querySelector("#statsLink").onclick  = async e => { e.preventDefault(); append("assistant", JSON.stringify(await (await fetch(base+"/api/stats")).json(), null, 2)); };
  document.querySelector("#historyLink").onclick= async e => { e.preventDefault(); append("assistant", JSON.stringify(await (await fetch(base+`/api/history?cid=${getCid()}`)).json(), null, 2)); };
  document.querySelector("#exportLink").onclick = async e => { e.preventDefault(); append("assistant", JSON.stringify(await (await fetch(base+`/api/history/export?cid=${getCid()}`)).json(), null, 2)); };

  // --- New session / Clear chat / Download / Purge all
  newCidBtn.onclick = () => { setCid(crypto.randomUUID()); clearUI(); append("assistant", "Started fresh session."); };
  clearBtn.onclick = async () => {
    const cid = getCid();
    const sure = confirm("Clear chat for this session (local log + server history)?");
    if(!sure) return;
    try{
      await fetch(`${base}/api/history?cid=${encodeURIComponent(cid)}`, { method: "DELETE" });
      clearUI();
      append("assistant", "Cleared chat history for this session.");
    }catch(e){
      clearUI();
      append("assistant", "Cleared UI. Server clear may have failed: " + e.message);
    }
  };
  downloadBtn.onclick = async () => {
    const cid = getCid();
    const res = await fetch(`${base}/api/history/export_file?cid=${encodeURIComponent(cid)}`);
    if(!res.ok){ append("assistant", "Download failed."); return; }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const stamp = new Date().toISOString().replace(/[:.]/g,"-");
    a.href = url; a.download = `friday_${cid.slice(0,8)}_${stamp}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  };
  purgeAllBtn.onclick = async () => {
    const tok = prompt("Admin token (required to purge ALL sessions):");
    if(!tok) return;
    if(!confirm("This will clear ALL sessions on the server. Continue?")) return;
    try{
      const r = await fetch(`${base}/api/admin/purge_all`, { method:"DELETE", headers: { "X-Admin-Token": tok } });
      const j = await r.json();
      if(!r.ok){ append("assistant", "Admin purge failed: " + (j.error||r.status)); return; }
      clearUI();
      append("assistant", `Purged ${j.purged_count} sessions.`);
    }catch(e){
      append("assistant", "Admin purge error: " + e.message);
    }
  };

  // --- Boot
  (function boot(){
    loadTheme();
    getCid(); loadModels();
    fetch(`${base}/debug/health`).then(r=>r.json()).then(j=>{ if(j.commit) commitSpan.textContent = "commit " + j.commit; });
    msg.addEventListener("keydown", e => { if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); } });
    sendBtn.onclick = send;
  })();
</script>
</body>
</html>









