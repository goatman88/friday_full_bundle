<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Friday AI • Stream+Tools++</title>
<style>
  :root { --bg:#0f172a; --panel:#0b1226; --muted:#94a3b8; --text:#e2e8f0; --accent:#60a5fa; --accent2:#a78bfa; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 1200px at 10% -20%, #1d2b54 0, transparent 55%),var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px 16px;background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.55) 70%, transparent);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700}
  .badge{font-size:12px;color:#cbd5e1;border:1px solid rgba(148,163,184,.35);padding:2px 8px;border-radius:999px}
  .live{border-color: rgba(16,185,129,.5); color:#d1fae5;}
  .dev{border-color: rgba(245,158,11,.5); color:#fef3c7;}
  .warn{border-color: rgba(245,158,11,.5); color:#fde68a;}
  main{max-width:1000px;margin:16px auto 120px;padding:0 16px}
  #chat{border:1px solid rgba(255,255,255,.07);border-radius:16px;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,.25)}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px;background:rgba(255,255,255,.02);border-bottom:1px solid rgba(255,255,255,.06)}
  .toolbar input,.toolbar select,.toolbar button{background:#0b1226;color:var(--text);border:1px solid rgba(255,255,255,.1);padding:8px 10px;border-radius:10px;outline:none}
  .toolbar button.btn{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;font-weight:600}
  .muted{color:var(--muted);font-size:12px}
  .hint{font-size:12px;color:#cbd5e1;margin-left:6px}
  #log{max-height:58vh;overflow:auto;padding:12px}
  .msg{margin:0 0 12px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.07);white-space:pre-wrap}
  .u{background:rgba(96,165,250,.08);border-color:rgba(96,165,250,.25)}
  .a{background:rgba(167,139,250,.08);border-color:rgba(167,139,250,.25)}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  .trace{background:rgba(255,255,255,.03); border:1px dashed rgba(255,255,255,.15); padding:8px 10px; border-radius:8px; margin-top:6px; font-size:12px; color:#d1d5db}
  .trace pre{white-space:pre-wrap; margin:6px 0 0}
  .composer{display:flex;gap:10px;padding:10px;background:rgba(255,255,255,.02);border-top:1px solid rgba(255,255,255,.06)}
  #input{flex:1;background:#0b1226;border:1px solid rgba(255,255,255,.1);border-radius:12px;color:var(--text);padding:12px 14px;min-height:46px;max-height:160px;resize:vertical}
  .send{min-width:98px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;font-weight:700}
  .links a{color:var(--muted);text-decoration:none;margin-left:10px;font-size:13px}
  .links a:hover{color:var(--text)}
  .row{display:flex;gap:10px; align-items:center}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15); font-size:12px}
  .pill.warn{border-color:rgba(245,158,11,.45); color:#fde68a}
  .pill.ok{border-color:rgba(16,185,129,.45); color:#d1fae5}
  .pill.err{border-color:rgba(239,68,68,.45); color:#fecaca}
</style>
</head>
<body>
<header>
  <div class="brand">
    <svg width="26" height="26" viewBox="0 0 48 48" fill="none"><defs><linearGradient id="g" x1="0" y1="48" x2="48" y2="0"><stop stop-color="#60a5fa"/><stop offset="1" stop-color="#a78bfa"/></linearGradient></defs><rect rx="12" width="48" height="48" fill="url(#g)"/></svg>
    <div>Friday AI</div>
    <div id="modeBadge" class="badge">checking…</div>
  </div>
  <div class="links">
    <a href="/routes" target="_blank">routes</a>
    <a href="/debug/health" target="_blank">health</a>
    <a href="/api/history" target="_blank">history</a>
    <a href="/api/metrics" target="_blank">metrics</a>
  </div>
</header>

<main>
  <section id="chat">
    <div class="toolbar">
      <span class="muted">User</span>
      <input id="username" placeholder="username" style="width:180px">
      <button id="saveUser" class="btn">Set</button>

      <span class="muted" style="margin-left:8px">Model</span>
      <select id="model" style="width:180px"></select>
      <button id="useModel" class="btn">Use</button>
      <span id="modelHint" class="hint"></span>

      <span class="muted" style="margin-left:8px">Mode</span>
      <select id="sendMode">
        <option value="stream_plus" selected>Stream+ (tools)</option>
        <option value="stream_legacy">Legacy Stream</option>
        <option value="nonstream_tools">Non-stream (tools)</option>
      </select>

      <button id="clearHistory" style="margin-left:auto">Clear history</button>
      <span id="rlBadge" class="pill warn" title="Rate-limit status">RL…</span>
    </div>

    <div id="log"></div>

    <div class="composer">
      <textarea id="input" placeholder="Ask anything. Try: weather in Paris; search CUDA graphs; ‘use my docs about X’…"></textarea>
      <button id="send" class="send">Send</button>
    </div>
  </section>
  <p class="muted" style="margin-top:8px">Tip: username & model saved in this browser. Use “Stream+ (tools)” for Jarvis vibes.</p>
</main>

<script>
const $ = sel => document.querySelector(sel);
const log = $("#log"), input = $("#input"), sendBtn = $("#send");
const userEl = $("#username"), saveUserBtn = $("#saveUser");
const modelSel = $("#model"), useModelBtn = $("#useModel"), modelHint = $("#modelHint");
const modeBadge = $("#modeBadge"), sendMode = $("#sendMode");
const rlBadge = $("#rlBadge");
const clearBtn = $("#clearHistory");

const state = {
  username: localStorage.getItem("friday.username") || "guest",
  model: localStorage.getItem("friday.model") || null,
};
userEl.value = state.username;

function add(role, text){
  const wrap = document.createElement("div");
  wrap.className = "msg " + (role === "user" ? "u" : "a");
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = `${role === "user" ? (state.username || "guest") : "Friday"} • ${new Date().toLocaleTimeString()}`;
  const body = document.createElement("div");
  body.textContent = text;
  wrap.appendChild(meta); wrap.appendChild(body);
  log.appendChild(wrap); log.scrollTop = log.scrollHeight;
  return {wrap, body};
}

function addTrace(parent, title, obj){
  const d = document.createElement("div");
  d.className = "trace";
  d.innerHTML = `<strong>${title}</strong><pre>${JSON.stringify(obj, null, 2)}</pre>`;
  parent.appendChild(d);
  log.scrollTop = log.scrollHeight;
}

async function jsonFetch(url, opts={}){
  const res = await fetch(url, { headers:{ "Content-Type":"application/json", ...(opts.headers||{}) }, ...opts });
  if(!res.ok){
    let msg = `${res.status} ${res.statusText}`;
    try{ const j = await res.json(); msg = j.error || j.reason || msg; }catch{}
    throw new Error(msg);
  }
  return res.json();
}

async function checkHealth(){
  try{
    const h = await jsonFetch("/debug/health");
    const live = !!h.openai;
    modeBadge.textContent = live ? "Live (OpenAI)" : "Dev Echo";
    modeBadge.className = "badge " + (live ? "live" : "dev");
  }catch{
    modeBadge.textContent = "Unknown";
    modeBadge.className = "badge warn";
  }
}

async function loadModels(){
  try{
    const data = await jsonFetch("/api/models");
    modelSel.innerHTML = "";
    (data.available||[]).forEach(m=>{
      const opt = document.createElement("option");
      opt.value=m; opt.textContent=m;
      if((state.model && state.model===m) || (!state.model && data.active===m)) opt.selected = true;
      modelSel.appendChild(opt);
    });
    modelHint.textContent = `active: ${data.active}`;
    if(!state.model) { state.model = data.active; localStorage.setItem("friday.model", state.model); }
  }catch{ modelHint.textContent = "models unavailable"; }
}

async function loadHistory(){
  try{
    const items = await jsonFetch(`/api/history?username=${encodeURIComponent(state.username)}`);
    if(Array.isArray(items)){
      items.forEach(it=>{ add("user", it.message); add("assistant", it.reply); });
    }
  }catch{}
}

async function pollRL(){
  try{
    const m = await jsonFetch("/api/metrics");
    const rem = m?.rate_limit?.remaining ?? "?";
    rlBadge.textContent = `RL ${rem}`;
    rlBadge.className = "pill " + (rem <= 2 ? "err" : rem < 10 ? "warn" : "ok");
  }catch{
    rlBadge.textContent = "RL ?";
    rlBadge.className = "pill warn";
  }
}

saveUserBtn.addEventListener("click", ()=>{
  state.username = (userEl.value||"guest").trim() || "guest";
  localStorage.setItem("friday.username", state.username);
  add("assistant", `Got it, hi ${state.username}!`);
});

useModelBtn.addEventListener("click", async ()=>{
  const m = modelSel.value;
  try{
    const res = await jsonFetch("/api/model", { method:"POST", body: JSON.stringify({ model: m })});
    state.model = res.active || m;
    localStorage.setItem("friday.model", state.model);
    modelHint.textContent = `active: ${state.model}`;
    add("assistant", `Using model: ${state.model}`);
  }catch(e){ add("assistant", "Couldn’t set model: "+e.message); }
});

clearBtn.addEventListener("click", async ()=>{
  try{
    await jsonFetch("/api/history/clear", {method:"POST", body: JSON.stringify({username: state.username})});
    log.innerHTML = "";
    add("assistant", "History cleared.");
  }catch(e){
    add("assistant", "Couldn’t clear history: "+e.message);
  }
});

// --- Send modes ---
function sendStreamPlus(text){
  add("user", text);
  const {wrap, body} = add("assistant", "");
  const params = new URLSearchParams({
    message: text,
    username: state.username || "guest",
    model: state.model || ""
  });
  const es = new EventSource(`/api/chat/stream-tools?${params.toString()}`);
  let closed = false;
  es.onmessage = (ev) => {
    if(!ev.data) return;
    try{
      const obj = JSON.parse(ev.data);
      if(obj.type === "delta"){ body.textContent += obj.delta; }
      else if(obj.type === "tool_call"){ addTrace(wrap, `Calling tool: ${obj.name}`, obj); }
      else if(obj.type === "tool_result"){ addTrace(wrap, `Tool result: ${obj.name}`, obj); }
      else if(obj.type === "error"){ addTrace(wrap, "Error", obj); }
      else if(obj.type === "done"){ es.close(); closed = true; }
      log.scrollTop = log.scrollHeight;
    }catch{}
  };
  es.onerror = () => { if(!closed) es.close(); };
}

function sendLegacyStream(text){
  add("user", text);
  const {body} = add("assistant", "");
  const params = new URLSearchParams({
    message: text,
    username: state.username || "guest",
    model: state.model || ""
  });
  const es = new EventSource(`/api/chat/stream?${params.toString()}`);
  let closed = false;
  es.onmessage = (ev) => {
    if(!ev.data) return;
    try{
      const obj = JSON.parse(ev.data);
      if(obj.delta){ body.textContent += obj.delta; }
      if(obj.done){ es.close(); closed = true; }
      if(obj.error){ body.textContent += `\n[error] ${obj.error}`; }
      log.scrollTop = log.scrollHeight;
    }catch{}
  };
  es.onerror = () => { if(!closed) es.close(); };
}

async function sendNonstreamTools(text){
  add("user", text);
  const {wrap} = add("assistant", "…");
  try{
    const res = await jsonFetch("/api/chat", {
      method:"POST",
      body: JSON.stringify({
        message: text,
        username: state.username || "guest",
        model: state.model || "",
        tools: true
      })
    });
    wrap.lastChild.textContent = res.reply || "(no reply)";
    if (res.traces && res.traces.length) addTrace(wrap, "Tool trace", res.traces);
    if (res.usage) addTrace(wrap, "Usage", res.usage);
    await pollRL();
  }catch(e){
    wrap.lastChild.textContent = "Error: " + e.message;
  }
}

sendBtn.addEventListener("click", ()=>{
  const text = (input.value||"").trim();
  if(!text) return;
  input.value = "";
  const mode = sendMode.value;
  if (mode === "stream_plus") sendStreamPlus(text);
  else if (mode === "stream_legacy") sendLegacyStream(text);
  else sendNonstreamTools(text);
});

input.addEventListener("keydown", (e)=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendBtn.click(); }
});

// init
checkHealth();
loadModels();
loadHistory();
pollRL();
setInterval(pollRL, 15000);
</script>
</body>
</html>


