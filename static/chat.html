<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Friday Chat</title>
<style>
  :root { --bg:#0f172a; --panel:#0b1226; --text:#e2e8f0; --muted:#94a3b8; --border:rgba(255,255,255,.08); }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:rgba(15,23,42,.75);backdrop-filter:saturate(1.2) blur(6px);
         border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;padding:10px 14px}
  header .title{font-weight:800}
  main{max-width:1200px;margin:16px auto;padding:0 16px;display:grid;grid-template-columns:2fr 1fr;gap:16px}
  @media (max-width:980px){ main{grid-template-columns:1fr} }
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .section{padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input, select, button, textarea{background:var(--panel);color:var(--text);border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 10px}
  input, select{height:36px}
  textarea{width:100%;min-height:80px;resize:vertical}
  button.primary{background:linear-gradient(135deg,#60a5fa,#a78bfa);border:none;font-weight:700}
  .col{display:flex;flex-direction:column;gap:8px}
  .messages{padding:10px 12px;max-height:58vh;overflow:auto}
  .msg{padding:10px;border:1px solid var(--border);border-radius:10px;margin:8px 0}
  .user{background:rgba(59,130,246,.08)}
  .bot{background:rgba(168,85,247,.08)}
  small{color:var(--muted)}
  pre{white-space:pre-wrap}
  code{background:rgba(255,255,255,.06);padding:2px 6px;border-radius:6px}
  .log{padding:10px 12px;height:200px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;background:#071023;border-top:1px solid var(--border)}
  a{color:#93c5fd;text-decoration:none}
  .pill{font-size:12px;background:rgba(255,255,255,.07);padding:2px 6px;border-radius:999px;border:1px solid var(--border)}
  .sources{font-size:13px;color:#c7d2fe;margin-top:6px}
</style>
</head>
<body>
<header>
  <div class="title">Friday</div>
  <div class="pill" id="modelPill">model: …</div>
  <div class="pill" id="presetPill">preset: …</div>
  <div class="pill" id="rlPill">rate: …</div>
  <div style="margin-left:auto;display:flex;gap:10px">
    <a href="/routes" target="_blank">Routes</a>
  </div>
</header>

<main>
  <div class="card">
    <div class="section col">
      <div class="row">
        <input id="username" placeholder="username" value="guest" style="width:200px">
        <select id="model" style="width:200px"></select>
        <select id="preset" style="width:180px"></select>
        <label class="row" style="gap:6px"><input type="checkbox" id="useStream" checked> Stream (tools)</label>
        <button id="btnClear" class="pill" title="clear history">Clear</button>
      </div>
      <textarea id="input" placeholder="Type your question…"></textarea>
      <div class="row">
        <button id="send" class="primary">Send</button>
        <small id="hint">Try “weather in Chicago” or “search NVIDIA earnings summary”.</small>
      </div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="log" id="log"></div>
  </div>

  <div class="card">
    <div class="section">
      <div class="row" style="justify-content:space-between">
        <strong>History</strong>
        <button id="refresh" class="pill">Refresh</button>
      </div>
      <div id="history" style="max-height:62vh;overflow:auto;padding:8px 12px"></div>
    </div>
  </div>
</main>

<script>
const $ = s => document.querySelector(s);
const log = (...a) => { const l=$("#log"); l.textContent += a.map(x=>typeof x==="string"?x:JSON.stringify(x)).join(" ")+"\n"; l.scrollTop=l.scrollHeight; };
const escapeHTML = s => (s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));

function addMsg(role, text, citations){
  const wrap = document.createElement("div");
  wrap.className = "msg "+(role==="user"?"user":"bot");
  let html = `<small>${role}</small><pre>${escapeHTML(text)}</pre>`;
  if (role!=="user" && citations && citations.length){
    const items = citations.map((c,i)=>{
      const fn = (c.meta && (c.meta.filename || c.meta.file || "")) || c.id || `src-${i+1}`;
      return `<div>${i+1}. ${escapeHTML(fn)}</div>`;
    }).join("");
    html += `<div class="sources"><strong>Sources</strong>${items}</div>`;
  }
  wrap.innerHTML = html;
  $("#messages").appendChild(wrap);
  $("#messages").scrollTop = $("#messages").scrollHeight;
}

async function loadModels(){
  const u=$("#username").value||"guest";
  const r = await fetch(`/api/models?username=${encodeURIComponent(u)}`); const j = await r.json();
  $("#modelPill").textContent = "model: "+(j.active||"gpt-4o-mini");
  const sel = $("#model"); sel.innerHTML = "";
  (j.available||["gpt-4o-mini"]).forEach(m=>{
    const o=document.createElement("option"); o.value=m; o.textContent=m; if(m===j.active) o.selected=true; sel.appendChild(o);
  });
}
async function saveModel(){
  const u=$("#username").value||"guest", m=$("#model").value;
  await fetch("/api/model",{method:"POST",headers:{"Content-Type":"application/json"}, body: JSON.stringify({username:u, model:m})});
  $("#modelPill").textContent = "model: "+m;
}

async function loadPresets(){
  const u=$("#username").value||"guest";
  const r = await fetch(`/api/presets?username=${encodeURIComponent(u)}`); const j = await r.json();
  $("#presetPill").textContent = "preset: "+j.active;
  const sel=$("#preset"); sel.innerHTML="";
  (j.presets||["concise"]).forEach(p=>{
    const o=document.createElement("option"); o.value=p; o.textContent=p; if(p===j.active) o.selected=true; sel.appendChild(o);
  });
}
async function savePreset(){
  const u=$("#username").value||"guest", p=$("#preset").value;
  await fetch("/api/presets",{method:"POST",headers:{"Content-Type":"application/json"}, body: JSON.stringify({username:u, preset:p})});
  $("#presetPill").textContent = "preset: "+p;
}

async function loadRate(){
  const r = await fetch("/api/metrics"); const j = await r.json();
  const rl = j.rate_limit||{}; $("#rlPill").textContent = `rate: ${rl.remaining ?? "?"} left`;
}
async function loadHistory(){
  const u=$("#username").value||"guest";
  const r = await fetch(`/api/history?username=${encodeURIComponent(u)}&limit=200`);
  const j = await r.json(); const h=$("#history"); h.innerHTML="";
  j.forEach(it=>{
    const d=document.createElement("div");
    const when = new Date((it.ts||0)*1000).toLocaleString();
    const mem = it.memory ? " (memory)" : "";
    d.className="msg"; d.innerHTML = `<small>${when}${mem}</small><div><strong>Q:</strong> ${escapeHTML(it.message||"")}</div><div><strong>A:</strong> ${escapeHTML(it.reply||"")}</div>`;
    h.appendChild(d);
  });
}

$("#model").addEventListener("change", saveModel);
$("#preset").addEventListener("change", savePreset);
$("#refresh").onclick = loadHistory;
$("#btnClear").onclick = async ()=>{
  const u=$("#username").value||"guest";
  const r = await fetch("/api/history/clear",{method:"POST",headers:{"Content-Type":"application/json"}, body: JSON.stringify({username:u})});
  const j = await r.json(); addMsg("bot", `cleared: ${j.cleared}`);
  loadHistory();
};

async function send(){
  const q = $("#input").value.trim(); if(!q) return;
  const u = $("#username").value||"guest";
  const model = $("#model").value;
  const preset = $("#preset").value;

  addMsg("user", q);
  $("#input").value="";
  $("#log").textContent = "";

  if($("#useStream").checked){
    const url = `/api/chat/stream_tools?message=${encodeURIComponent(q)}&username=${encodeURIComponent(u)}&model=${encodeURIComponent(model)}&preset=${encodeURIComponent(preset)}`;
    const es = new EventSource(url);
    let bot = document.createElement("div");
    bot.className="msg bot"; bot.innerHTML="<small>assistant</small><pre></pre>";
    $("#messages").appendChild(bot);
    const pre = bot.querySelector("pre");
    let finalCites = [];

    es.onmessage = (e)=>{
      if(!e.data) return;
      let m={}; try{ m=JSON.parse(e.data);}catch(_){}
      if(m.type==="tool_event"){ log(`→ tool: ${m.tool}`, m.args || {}, m.result || {}); }
      else if(m.type==="delta"){ pre.textContent += (m.delta || ""); }
      else if(m.type==="citations"){ finalCites = m.citations || []; }
      else if(m.type==="usage"){ log("usage", m.usage || {}); }
      else if(m.type==="done"){
        es.close(); loadHistory(); loadRate();
        if(finalCites.length){
          const src = document.createElement("div");
          src.className="sources";
          src.innerHTML = "<strong>Sources</strong>" + finalCites.map((c,i)=>{
            const fn = (c.meta && (c.meta.filename||c.meta.file||"")) || c.id || `src-${i+1}`;
            return `<div>${i+1}. ${escapeHTML(fn)}</div>`;
          }).join("");
          bot.appendChild(src);
        }
      }
    };
    es.onerror = ()=>{ es.close(); log("stream error"); };
  } else {
    const r = await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"}, body: JSON.stringify({message:q, username:u, model, preset})});
    const j = await r.json();
    addMsg("bot", j.reply || j.error || "(no reply)", j.citations || []);
    if(j.traces){ j.traces.forEach(t=> log(`→ tool: ${t.tool}`, t.args||{}, t.result||{})); }
    loadHistory(); loadRate();
  }
}

$("#send").onclick = send;
$("#input").addEventListener("keydown", (e)=>{ if(e.key==="Enter" && (e.ctrlKey||e.metaKey)){ send(); } });

loadModels(); loadPresets(); loadRate(); loadHistory();
</script>
</body>
</html>



