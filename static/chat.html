<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Friday AI • Vector + Refresh</title>
<style>
  :root { --bg:#0f172a; --panel:#0b1226; --muted:#94a3b8; --text:#e2e8f0; --accent:#60a5fa; --accent2:#a78bfa; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 1200px at 10% -20%, #1d2b54 0, transparent 55%),var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;gap:12px;padding:12px 16px;background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.55) 70%, transparent);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,.06)}
  .brand{display:flex;gap:10px;align-items:center;font-weight:700}
  .badge{font-size:12px;color:#cbd5e1;border:1px solid rgba(148,163,184,.35);padding:2px 8px;border-radius:999px}
  .live{border-color: rgba(16,185,129,.5); color:#d1fae5;}
  .dev{border-color: rgba(245,158,11,.5); color:#fef3c7;}
  main{max-width:1100px;margin:16px auto 120px;padding:0 16px}
  #chat{border:1px solid rgba(255,255,255,.07);border-radius:16px;overflow:hidden;box-shadow:0 8px 40px rgba(0,0,0,.25)}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:10px;background:rgba(255,255,255,.02);border-bottom:1px solid rgba(255,255,255,.06)}
  .toolbar input,.toolbar select,.toolbar button{background:#0b1226;color:var(--text);border:1px solid rgba(255,255,255,.1);padding:8px 10px;border-radius:10px;outline:none}
  .toolbar button.btn{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;font-weight:600}
  .muted{color:var(--muted);font-size:12px}
  .hint{font-size:12px;color:#cbd5e1;margin-left:6px}
  #log{max-height:58vh;overflow:auto;padding:12px}
  .msg{margin:0 0 12px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.07);white-space:pre-wrap}
  .u{background:rgba(96,165,250,.08);border-color:rgba(96,165,250,.25)}
  .a{background:rgba(167,139,250,.08);border-color:rgba(167,139,250,.25)}
  .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
  .trace{background:rgba(255,255,255,.03); border:1px dashed rgba(255,255,255,.15); padding:8px 10px; border-radius:8px; margin-top:6px; font-size:12px; color:#d1d5db}
  .composer{display:flex;gap:10px;padding:10px;background:rgba(255,255,255,.02);border-top:1px solid rgba(255,255,255,.06)}
  #input{flex:1;background:#0b1226;border:1px solid rgba(255,255,255,.1);border-radius:12px;color:var(--text);padding:12px 14px;min-height:46px;max-height:160px;resize:vertical}
  .send{min-width:98px;border-radius:12px;border:none;background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;font-weight:700}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.15); font-size:12px}
  .ok{border-color:rgba(16,185,129,.45); color:#d1fae5}
  .warn{border-color:rgba(245,158,11,.45); color:#fde68a}
  .err{border-color:rgba(239,68,68,.45); color:#fecaca}
  .links a{color:#94a3b8;text-decoration:none;margin-left:10px;font-size:13px}
  .links a:hover{color:#e2e8f0}
  .admin-only{display:none}
  .admin-on .admin-only{display:inline-flex}
</style>
</head>
<body>
<header>
  <div class="brand">
    <svg width="26" height="26" viewBox="0 0 48 48" fill="none"><defs><linearGradient id="g" x1="0" y1="48" x2="48" y2="0"><stop stop-color="#60a5fa"/><stop offset="1" stop-color="#a78bfa"/></linearGradient></defs><rect rx="12" width="48" height="48" fill="url(#g)"/></svg>
    <div>Friday AI</div>
    <div id="mode" class="badge">checking…</div>
  </div>
  <div class="links">
    <a href="/routes" target="_blank">routes</a>
    <a href="/debug/health" target="_blank">health</a>
    <a href="/api/history" target="_blank">history</a>
    <a href="/api/metrics" target="_blank">metrics</a>
  </div>
</header>

<main>
  <section id="chat">
    <div class="toolbar">
      <span class="muted">User</span>
      <input id="username" placeholder="username" style="width:160px">
      <button id="saveUser" class="btn">Set</button>

      <span class="muted" style="margin-left:8px">Model</span>
      <select id="model" style="width:180px"></select>
      <button id="useModel" class="btn">Use</button>
      <span id="modelHint" class="hint"></span>

      <span class="muted" style="margin-left:auto">Login</span>
      <input id="password" type="password" placeholder="password (if set)" style="width:150px">
      <input id="adminCode" type="text" placeholder="admin code (optional)" style="width:160px">
      <button id="loginBtn">Login</button>
      <button id="logoutBtn">Logout</button>

      <span id="authBadge" class="pill warn">anon</span>
    </div>

    <div class="toolbar">
      <span class="muted">Upload (PDF/TXT/MD/DOCX/HTML)</span>
      <input id="fileInput" type="file" multiple accept=".pdf,.txt,.md,.docx,.html,.htm">
      <button id="uploadBtn">Upload & Index</button>

      <span class="muted" style="margin-left:12px">JSON mode</span>
      <input id="jsonPrompt" placeholder='e.g., {"title": "...", "bullets": []} about topic' style="min-width:320px">
      <button id="jsonBtn">Run</button>

      <button id="mintBtn" class="admin-only">Mint Admin Codes</button>
    </div>

    <div id="log"></div>

    <div class="composer">
      <textarea id="input" placeholder="Ask anything…"></textarea>
      <button id="send" class="send">Send</button>
    </div>
  </section>
  <p class="muted" style="margin-top:8px">Tip: login to enable uploads & admin. Admin-only controls appear when your role is admin.</p>
</main>

<script>
const $ = s => document.querySelector(s);
const state = {
  username: localStorage.getItem("friday.username") || "guest",
  access: localStorage.getItem("friday.access") || null,
  refresh: localStorage.getItem("friday.refresh") || null,
  role: localStorage.getItem("friday.role") || "anon",
  model: localStorage.getItem("friday.model") || null,
};

const log = $("#log");
function add(role, text){
  const wrap = document.createElement("div");
  wrap.className = "msg " + (role === "user" ? "u" : "a");
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = `${role === "user" ? (state.username || "guest") : "Friday"} • ${new Date().toLocaleTimeString()}`;
  const body = document.createElement("div");
  body.textContent = text;
  wrap.appendChild(meta); wrap.appendChild(body);
  log.appendChild(wrap); log.scrollTop = log.scrollHeight;
  return {wrap, body};
}

function setAuthUI(){
  const badge = $("#authBadge");
  if(state.access){
    badge.textContent = state.role || "user";
    badge.className = "pill ok";
    document.body.classList.toggle("admin-on", state.role === "admin");
  }else{
    badge.textContent = "anon";
    badge.className = "pill warn";
    document.body.classList.remove("admin-on");
  }
}

function headers(json=true){
  const h = json ? {"Content-Type":"application/json"} : {};
  if(state.access) h["Authorization"] = "Bearer " + state.access;
  return h;
}

// Fetch helper with auto-refresh on 401
async function fetchAuth(url, opts={}){
  let res = await fetch(url, {headers:{...headers(true), ...(opts.headers||{})}, ...opts});
  if(res.status !== 401) return res;
  // try refresh
  if(!state.refresh) return res;
  try{
    const r = await fetch("/api/auth/refresh", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({refresh_token: state.refresh})
    });
    if(!r.ok) return res;
    const j = await r.json();
    state.access = j.access_token; state.role = j.user?.role || state.role;
    localStorage.setItem("friday.access", state.access);
    localStorage.setItem("friday.role", state.role);
    setAuthUI();
    // retry original
    res = await fetch(url, {headers:{...headers(true), ...(opts.headers||{})}, ...opts});
    return res;
  }catch{ return res; }
}

async function jsonFetch(url, opts={}){
  const res = await fetchAuth(url, opts);
  if(!res.ok){
    let msg = `${res.status} ${res.statusText}`;
    try{ const j = await res.json(); msg = j.error || j.reason || msg; }catch{}
    throw new Error(msg);
  }
  return res.json();
}

// UI init
$("#username").value = state.username;

async function checkHealth(){
  try{
    const j = await jsonFetch("/debug/health", {headers: headers(true)});
    const live = !!j.openai; const m = $("#mode");
    m.textContent = live ? "Live" : "Dev";
    m.className = "badge " + (live ? "live" : "dev");
  }catch{
    const m = $("#mode"); m.textContent = "unknown"; m.className = "badge";
  }
}

async function loadModels(){
  try{
    const j = await jsonFetch("/api/models");
    const sel = $("#model"); sel.innerHTML = "";
    (j.available||[]).forEach(x=>{
      const o = document.createElement("option"); o.value=x; o.textContent=x; sel.appendChild(o);
    });
    const active = j.active;
    $("#modelHint").textContent = `active: ${active}`;
    if(!state.model) { state.model = active; localStorage.setItem("friday.model", state.model); }
    Array.from(sel.options).forEach(o=>{ if(o.value===state.model) o.selected=true; });
  }catch{}
}

async function loadHistory(){
  try{
    const j = await jsonFetch(`/api/history?username=${encodeURIComponent(state.username)}`);
    (j||[]).forEach(it=>{ add("user", it.message); add("assistant", it.reply); });
  }catch{}
}

// Controls
$("#saveUser").onclick = () => {
  state.username = ($("#username").value || "guest").trim() || "guest";
  localStorage.setItem("friday.username", state.username);
  add("assistant", `Yo ${state.username}, locked in.`);
};

$("#useModel").onclick = async () => {
  const m = $("#model").value;
  try{
    const j = await jsonFetch("/api/model", {method:"POST", body: JSON.stringify({model: m})});
    state.model = j.active || m; localStorage.setItem("friday.model", state.model);
    $("#modelHint").textContent = `active: ${state.model}`;
    add("assistant", `Using model: ${state.model}`);
  }catch(e){ add("assistant", "Set model failed: " + e.message); }
};

$("#loginBtn").onclick = async () => {
  const body = {username: ($("#username").value||"guest").trim(), password: $("#password").value, admin_code: $("#adminCode").value};
  try{
    const j = await jsonFetch("/api/auth/login", {method:"POST", body: JSON.stringify(body)});
    state.access = j.access_token; state.refresh = j.refresh_token; state.role = j.user?.role || "user";
    localStorage.setItem("friday.access", state.access);
    localStorage.setItem("friday.refresh", state.refresh);
    localStorage.setItem("friday.role", state.role);
    setAuthUI();
    add("assistant", `Logged in as ${j.user.username} (${state.role}).`);
  }catch(e){ add("assistant", "Login failed: " + e.message); }
};

$("#logoutBtn").onclick = () => {
  state.access = null; state.refresh = null; state.role = "anon";
  localStorage.removeItem("friday.access"); localStorage.removeItem("friday.refresh"); localStorage.setItem("friday.role","anon");
  setAuthUI(); add("assistant", "Logged out.");
};

$("#uploadBtn").onclick = async () => {
  const files = $("#fileInput").files;
  if(!files || !files.length){ add("assistant","Pick files first."); return; }
  if(!state.access){ add("assistant","Login first to upload."); return; }
  const fd = new FormData(); Array.from(files).forEach(f => fd.append("files", f));
  try{
    const res = await fetch("/api/upload", {method:"POST", body: fd, headers: state.access ? {"Authorization":"Bearer "+state.access} : {}});
    if(!res.ok){ const t = await res.text(); throw new Error(t); }
    const j = await res.json();
    add("assistant", `Indexed ${j.indexed_docs} docs (${j.chunks} chunks) via ${j.backend}.`);
  }catch(e){ add("assistant", "Upload failed: " + e.message); }
};

$("#jsonBtn").onclick = async () => {
  const p = ($("#jsonPrompt").value||"").trim(); if(!p){ add("assistant","Type a JSON-mode prompt."); return; }
  try{
    const j = await jsonFetch("/api/structured", {method:"POST", body: JSON.stringify({prompt: p, model: state.model||""})});
    const {wrap} = add("assistant", "JSON result:");
    const tr = document.createElement("div"); tr.className = "trace";
    tr.innerHTML = `<strong>JSON</strong><pre>${JSON.stringify(j.json, null, 2)}</pre>`;
    wrap.appendChild(tr);
  }catch(e){ add("assistant","Structured failed: "+e.message); }
};

$("#mintBtn").onclick = async () => {
  if(state.role !== "admin"){ add("assistant","Admin only."); return; }
  try{
    const j = await jsonFetch("/api/admin/mint", {method:"POST", body: JSON.stringify({count: 3})});
    const {wrap} = add("assistant", "Minted codes:");
    const tr = document.createElement("div"); tr.className="trace";
    tr.innerHTML = `<strong>Tokens</strong><pre>${JSON.stringify(j.tokens, null, 2)}</pre>`;
    wrap.appendChild(tr);
  }catch(e){ add("assistant","Mint failed: "+e.message); }
};

$("#send").onclick = async () => {
  const text = ($("#input").value||"").trim(); if(!text) return;
  $("#input").value = "";
  add("user", text);
  const {wrap} = add("assistant", "…");
  try{
    const j = await jsonFetch("/api/chat", {
      method:"POST",
      body: JSON.stringify({message: text, username: state.username || "guest", model: state.model || ""})
    });
    wrap.lastChild.textContent = j.reply || "(no reply)";
    if (j.traces && j.traces.length){
      const tr = document.createElement("div"); tr.className="trace";
      tr.innerHTML = `<strong>Tools</strong><pre>${JSON.stringify(j.traces, null, 2)}</pre>`;
      wrap.appendChild(tr);
    }
  }catch(e){ wrap.lastChild.textContent = "Error: " + e.message; }
};

// init
(async function init(){
  setAuthUI();
  await checkHealth();
  await loadModels();
  await loadHistory();
})();
</script>
</body>
</html>



