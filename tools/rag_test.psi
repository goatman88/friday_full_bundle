# tools/rag_test.ps1
# Purpose: quick end-to-end smoke test for the toy RAG endpoints

param()

# ---- guard rails: require env vars ----
if (-not $env:FRIDAY_BASE) { throw "Set  `\$env:FRIDAY_BASE`  to your Render URL (NO trailing slash), e.g. https://friday-xxxx.onrender.com" }
if (-not $env:API_TOKEN)   { throw "Set  `\$env:API_TOKEN`  to your API token (the one you configured on Render)" }

# ---- convenience headers ----
$headers = @{
  Authorization = "Bearer $($env:API_TOKEN)"
  "Content-Type" = "application/json"
}

Write-Host ""
Write-Host "Checking routes..." -ForegroundColor Cyan
$routesUri = "$($env:FRIDAY_BASE)/__routes"
try {
  $routes = Invoke-RestMethod -Uri $routesUri -Headers $headers -Method Get
  $routes | ConvertTo-Json -Depth 6 | Out-String | Write-Host
} catch {
  Write-Host ($_ | Out-String) -ForegroundColor Red
  throw
}

# ---- 1) index a tiny note ----
Write-Host ""
Write-Host "Indexing a note into toy RAG..." -ForegroundColor Cyan
$indexUri  = "$($env:FRIDAY_BASE)/api/rag/index"
$indexBody = @{
  title  = "Acme"
  text   = "Acme builds rockets and coffee machines."
  source = "manual"
} | ConvertTo-Json

try {
  $indexResp = Invoke-RestMethod -Method Post -Uri $indexUri -Headers $headers -Body $indexBody
  Write-Host "Index response:" -ForegroundColor Green
  $indexResp | ConvertTo-Json -Depth 6 | Out-String | Write-Host
} catch {
  Write-Host "Index failed:" -ForegroundColor Red
  Write-Host ($_ | Out-String)
  throw
}

# ---- 2) query it ----
Write-Host ""
Write-Host "Querying toy RAG..." -ForegroundColor Cyan
$queryUri  = "$($env:FRIDAY_BASE)/api/rag/query"
$queryBody = @{
  question = "What does Acme build?"
} | ConvertTo-Json

try {
  $queryResp = Invoke-RestMethod -Method Post -Uri $queryUri -Headers $headers -Body $queryBody
  Write-Host "Query response:" -ForegroundColor Green
  $queryResp | ConvertTo-Json -Depth 6 | Out-String | Write-Host
} catch {
  Write-Host "Query failed:" -ForegroundColor Red
  Write-Host ($_ | Out-String)
  throw
}

Write-Host ""
Write-Host "Done. If you see ok:true and the right answer, toy RAG is working." -ForegroundColor Yellow
